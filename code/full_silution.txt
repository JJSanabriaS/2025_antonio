# =========================================
# STEP 1 â€” INSTALL DEPENDENCIES
# =========================================
!apt-get update -qq
!apt-get install -qq chromium-chromedriver
!pip install -q selenium tabulate ipywidgets pillow pandas requests openpyxl

# =========================================
# STEP 2 â€” IMPORTS
# =========================================
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import StaleElementReferenceException, TimeoutException
from IPython.display import display, clear_output
from google.colab import files
import ipywidgets as widgets
import pandas as pd
import time
from datetime import datetime

# =========================================
# STEP 3 â€” SELENIUM DRIVER SETUP
# =========================================
chrome_options = Options()
chrome_options.add_argument("--headless")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.add_argument("--window-size=1920,1080")

driver = webdriver.Chrome(options=chrome_options)
wait = WebDriverWait(driver, timeout=10)
driver.set_window_size(1920, 1080)

# =========================================
# STEP 4 â€” SUPPORT FUNCTIONS
# =========================================
def droplistven():
    url = "https://opcoes.net.br/opcoes/bovespa/AMBP3"
    driver.get(url)
    wait.until(EC.presence_of_element_located((By.ID, "grade-vencimentos-dates")))
    ids = driver.find_elements(By.TAG_NAME, "input")
    datas, mix = [], []
    for ii in ids:
        datas.append(ii.get_attribute("id"))
        mix.append(f"{ii.get_attribute('id')} - {ii.get_attribute('data-du')} d.u.")
    box = len(datas) - 5
    vendatas = datas[3:box]
    venlabels = mix[3:box]
    return venlabels, vendatas

def ajuste(url2, tiker, val_mom, strike, bid, ask):
    try:
        formula = (float(strike) - float(val_mom)) + (float(bid) - float(ask)) / (float(val_mom) + float(ask))
    except Exception:
        formula = 0.0
    return formula

def armazem(df,name):
    df.to_csv(name+".csv", index=False)
    df.to_excel(name+".xlsx", index=False)
    files.download(name+".csv")
    files.download(name+".xlsx")
    return df

def cadeiastring(i, datascall, datasput):
    try:
        strike = datascall[4] if len(datascall) > 26 else datascall[3]
        bid = datascall[11] or "0.0"
        ask = datasput[12] or "0.0"
        strike = strike.replace(".", "").replace(",", ".")
        bid = bid.replace(".", "").replace(",", ".")
        ask = ask.replace(".", "").replace(",", ".")
        return float(strike), float(bid), float(ask)
    except Exception:
        return 0.0, 0.0, 0.0

def extradados(table_container):
    retries = 3
    for attempt in range(retries):
        try:
            rows = table_container.find_elements(By.TAG_NAME, "tr")
            table_data = [[cell.text for cell in row.find_elements(By.TAG_NAME, "td")] for row in rows]
            return table_data
        except StaleElementReferenceException:
            time.sleep(1)
    return []

def prinp(url2):
    print(f"\n==== Iniciando {url2} ====")
    url = f"https://opcoes.net.br/opcoes/bovespa/{url2}"
    driver.get(url)

    try:
        table2 = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.ID, "divCotacaoAtual"))
        )
        cotiz = table2.text.split()
        val_mom = float(cotiz[1].replace(".", "").replace(",", "."))
    except Exception:
        val_mom = 0.0

    try:
        table_container = WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.ID, "tblListaOpc_wrapper"))
        )
    except TimeoutException:
        print("âš ï¸ Tabela nÃ£o carregou.")
        return pd.DataFrame()

    table_data = extradados(table_container)
    if not table_data:
        return pd.DataFrame()

    resumo_list = []
    for i in range(3, len(table_data), 2):
        if i + 1 >= len(table_data):
            break
        strike, bid, ask = cadeiastring(i, table_data[i], table_data[i + 1])
        formula = ajuste(url2, table_data[i][0] if table_data[i] else "N/A", val_mom, strike, bid, ask)
        resumo_list.append({
            "Ativo": url2,
            "Ticker": table_data[i][0] if table_data[i] else "N/A",
            "ValMom": val_mom,
            "Strike": strike,
            "Bid": bid,
            "Ask": ask,
            "Formula": formula
        })

    df2 = pd.DataFrame(resumo_list)
    return df2

def get_sel(driver, ativo):
    all_dataframes = pd.DataFrame()
    retries = 3
    if ativo == "todo":
        select_element = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.NAME, "IdAcao"))
        )
        select = Select(select_element)
        all_options = select.options
        option_texts = [opt.text.strip() for opt in all_options if len(opt.text.strip()) > 1]
        for option_text in option_texts:
            for attempt in range(retries):
                try:
                    driver.get(f"https://opcoes.net.br/opcoes/bovespa/{option_text}")
                    WebDriverWait(driver, 15).until(
                        EC.presence_of_element_located((By.ID, "tblListaOpc_wrapper"))
                    )
                    df_temp = prinp(option_text)
                    if not df_temp.empty:
                        all_dataframes = pd.concat([all_dataframes, df_temp], ignore_index=True)
                    break
                except (StaleElementReferenceException, TimeoutException):
                    time.sleep(2)
    else:
        driver.get(f"https://opcoes.net.br/opcoes/bovespa/{ativo}")
        WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.ID, "tblListaOpc_wrapper"))
        )
        df_temp = prinp(ativo)
        all_dataframes = pd.concat([all_dataframes, df_temp], ignore_index=True)
    return all_dataframes

# =========================================
# STEP 5 â€” INTERACTIVE USER INTERFACE
# =========================================
ativos_dropdown = widgets.Dropdown(description="Ativo:", layout=widgets.Layout(width="50%"))
vencimentos_multi = widgets.SelectMultiple(description="Vencimentos:", layout=widgets.Layout(width="60%", height="200px"))
user_threshold_input = widgets.FloatText(value=-0.05, description="Min Bid/Ask:", layout=widgets.Layout(width="30%"))

populate_btn = widgets.Button(description="1ï¸âƒ£ Populate", button_style="info")
run_btn = widgets.Button(description="2ï¸âƒ£ Run Scraper", button_style="warning", disabled=True)
save_btn = widgets.Button(description="3ï¸âƒ£ Save Results", button_style="success", disabled=True)

output_area = widgets.Output()
display(widgets.VBox([
    widgets.HBox([populate_btn, run_btn, save_btn]),
    ativos_dropdown, vencimentos_multi, user_threshold_input, output_area
]))

final_df = pd.DataFrame()
venlabels, vendatas = [], []

# ----------------------------------------
# Populate Button Logic
# ----------------------------------------
def on_populate_clicked(b):
    global venlabels, vendatas
    run_btn.disabled = True
    save_btn.disabled = True
    with output_area:
        clear_output()
        print("ðŸ”„ Loading ativos and vencimentos...")
    driver.get("https://opcoes.net.br/opcoes/bovespa/AURE3")
    select_element = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "IdAcao")))
    select = Select(select_element)
    all_options = select.options
    ativos = ["todo"] + [opt.text.strip() for opt in all_options if len(opt.text.strip()) > 1]
    ativos_dropdown.options = ativos
    venlabels, vendatas = droplistven()
    vencimentos_multi.options = list(zip(venlabels, vendatas))
    run_btn.disabled = False
    with output_area:
        print(f"âœ… Loaded {len(ativos)} ativos and {len(venlabels)} vencimentos.")

# ----------------------------------------
# Run Button Logic
# ----------------------------------------
def on_run_clicked(b):
    global final_df
    with output_area:
        clear_output()
        ativo = ativos_dropdown.value
        selected_vens = list(vencimentos_multi.value)
        threshold = user_threshold_input.value
        print(f"â–¶ï¸ Running scraper for {ativo}...")
        final_df = get_sel(driver, ativo)
        if final_df.empty:
            print("âš ï¸ No data found.")
            return
        final_df["MinBidAsk"] = final_df[["Bid", "Ask"]].min(axis=1)
        final_df = final_df[final_df["MinBidAsk"] >= threshold]
        top30 = final_df.sort_values(by="Formula", ascending=False).head(30)
        p

